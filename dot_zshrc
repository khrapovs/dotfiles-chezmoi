# ----- Powerlevel10k instant prompt (keep at top) -----
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ----- Oh My Zsh core -----
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"
plugins=(git docker docker-compose ssh python)
source "$ZSH/oh-my-zsh.sh"

# ----- Prompt (powerlevel10k) -----
# Keep p10k theme after OMZ so its hooks are in place
if [ -s /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme ]; then
  source /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme
fi
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

# ----- Aliases -----
alias ll="ls -la"
alias lg='lazygit'

# ----- yazi opener (interactive) -----
function y() {
  local tmp; tmp="$(mktemp -t "yazi-cwd.XXXXXX")" || return
  yazi "$@" --cwd-file="$tmp"
  if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
    builtin cd -- "$cwd"
  fi
  rm -f -- "$tmp"
}

# ----- Completions (cached) -----
# Use compinit -C to use cached dump file; rehash less often
autoload -U compinit
# If cache file missing or stale you can run: compaudit to diagnose
# You can also periodically rebuild cache with: rm -f ~/.zcompdump; compinit
compinit -C

# pipx completion (guarded)
if command -v register-python-argcomplete >/dev/null 2>&1; then
  eval "$(register-python-argcomplete pipx)"
fi

# uv completion (guarded)
if command -v uv >/dev/null 2>&1; then
  eval "$(uv generate-shell-completion zsh)"
fi

# ----- Interactive helpers (guarded & lighter) -----

# fzf keybindings/completion — avoid process substitution; use installed script if present
# Prefer Homebrew’s zsh scripts if installed (faster than `source <(fzf --zsh)`)
if [ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]; then
  source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
fi
if [ -f /opt/homebrew/opt/fzf/shell/completion.zsh ]; then
  source /opt/homebrew/opt/fzf/shell/completion.zsh
fi

# zoxide (guarded)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi
``
